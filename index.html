<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Authorized Organizations</title>
    <link rel="stylesheet" href="./index.css">
    <link href="//fonts.googleapis.com/css?family=Lato:300,400" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://dhqbrvplips7x.cloudfront.net/directory/9.18.0-5/assets/vendor-552b2cb90dee7571614445cb74a81c54.css">
    <link rel="stylesheet" href="https://dhqbrvplips7x.cloudfront.net/directory/9.18.0-5/assets/web-directory-cdcf5bb478b4cfbefe8e137411247a6b.css">
    </style>
</head>

<body>
    <div id="orgspan">
        <div class="application-scroll billing-summary">
            <div class="frame-layout subscription-summary">
                <div class="page-title">Billing & Usage</div>
                <div class="top-bar">
                    <div class="item">
                        <div class="billing-period-selector">
                            <div class="form-group">
                                <select class="form-control btn-default" id="selectPeriod">
                                    <option>0</option>
                                    <option>1</option>
                                    <option>2</option>
                                    <option>3</option>
                                    <option>4</option>
                                    <option>5</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <small id="dateRange"></small>
                </div>
                <div class="billing-summary-and-graph-container">
                    <div class="billing-summary-container">
                        <div class="billing-summary">
                            <div class="heading">
                                <span class="count" id="activeUsersCount"></span>
                                <span>Active Users</span>
                                <div class="subheading">Pre-Paid: <span id="prePaidUsersCount"></span> users &amp; devices through <span id="contractEndDate"></span></div>
                            </div>
                            <table class="summary-price-table">
                                <tr class="highlighted-row row">
                                    <td>Monthly Contract</td>
                                    <td class="price">
                                        <div>
                                            <span class="currency-number">
                                                <span class="dollar-sign">R</span>
                                                <span class="dollar-amount">0.00</span>
                                            </span>
                                        </div>
                                    </td>
                                    <td class="desc">
                                        Pre-Paid
                                    </td>
                                </tr>
                                <tr class="row">
                                    <td>Overage</td>
                                    <td class="price">
                                        <div>
                                            <span class="currency-number">
                                                <span class="dollar-sign">R</span>
                                                <span class="dollar-amount">0.00</span>
                                            </span>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="row">
                                    <td>Resources</td>
                                    <td class="price">
                                        <div>
                                            <span class="currency-number">
                                                <span class="dollar-sign">R</span>
                                                <span class="dollar-amount">0.00</span>
                                            </span>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="subtotal row">
                                    <td>Estimated Total</td>
                                    <td class="price">
                                        <div>
                                            <span class="currency-number">
                                                <span class="dollar-sign">R</span>
                                                <span class="dollar-amount">0.00</span>
                                            </span>
                                        </div>
                                    </td>
                                    <td>*</td>
                                </tr>
                                <tr class="balance row">
                                    <td class="excludes-voice-note">*Excludes any voice charges</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="billing-summary-graph-container"></div>
                </div>
                <div class="usage-container">
                    <!-- Users -->
                    <div class="margin-top">
                        <div class="billing-usage-group-table">
                            <table>
                                <thead>
                                    <tr class="headers border-bottom">
                                        <th class="usage-group-heading">Users</th>
                                        <th>Qty</th>
                                        <th class="unit-of-measure"></th>
                                        <th>Rate</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="users-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="margin-top"></div>

                    <!-- Apps -->
                    <div class="margin-top">
                        <div class="billing-usage-group-table">
                            <table>
                                <thead>
                                    <tr class="headers border-bottom">
                                        <th class="usage-group-heading">Apps</th>
                                        <th>Qty</th>
                                        <th class="unit-of-measure"></th>
                                        <th>Rate</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="apps-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="margin-top"></div>

                    <!-- Devices -->
                    <div class="margin-top">
                        <div class="billing-usage-group-table">
                            <table>
                                <thead>
                                    <tr class="headers border-bottom">
                                        <th class="usage-group-heading">Devices</th>
                                        <th>Qty</th>
                                        <th class="unit-of-measure"></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="devices-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="margin-top"></div>

                    <!-- Resources -->
                    <div class="margin-top">
                        <div class="ember-view">
                            <div class="billing-usage-group ember-view">
                                <div class="billing-usage-group-table ember-view">
                                    <table>
                                        <thead>
                                            <tr class="headers border-bottom">
                                                <th class="usage-group-heading">Resources (excludes Cloud Voice charges)</th>
                                                <th>Qty</th>
                                                <th class="unit-of-measure"></th>
                                                <th></th>
                                                <th></th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody id="resources-tbody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="resources-note">(1 GB = 1,000,000,000 bytes)</div>
                        </div>
                    </div>
                </div>

                <!-- FAQ Link -->
                <div class="faq">
                    <div class="display inline ember-view"><a href="https://help.mypurecloud.com/?p=42316" target="_blank" rel="noopener noreferrer">FAQ</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

<!-- #region Required Scripts -->
<script src="https://sdk-cdn.mypurecloud.com/javascript/69.1.0/purecloud-platform-client-v2.min.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.1/moment.min.js"></script>

<!-- #endregion -->

<script type="text/javascript" src="testData.js"></script>
<script type="text/javascript">

    //TODO How to get 'R' instead of 'ZAR'?

    //#region Settings

    const clientId = '9a1fd66e-13fc-47e0-997d-4a96e5dcf9bf';
    const redirectUri = window.location.href; // 'http://127.0.0.1:5500/index.html';
    const trustorOrgId = 'd3fc6ba5-80a5-45a9-b6f1-cf827445de08'; //CCBASA
    const environment = 'mypurecloud.ie';

    //#endregion

    const platformClient = require('platformClient');

    const client = platformClient.ApiClient.instance;
    client.setEnvironment(environment);
    let apiInstance = new platformClient.BillingApi();

    start();

    function start() {
        client.loginImplicitGrant(clientId, redirectUri, { state: undefined })
            .then((data) => {
                console.log('Logged In!');

                let opts = {
                    'billingPeriodIndex': $("#selectPeriod").val()
                };

                apiInstance.getBillingTrusteebillingoverviewTrustorOrgId(trustorOrgId, opts)
                    .then((data) => {
                        showData(data);
                    })
                    .catch((err) => {
                        console.log('There was a failure calling getBillingTrusteebillingoverviewTrustorOrgId');
                        console.error(err);
                    });
            })
            .catch((err) => {
                // Handle failure response
                console.error(err);
                alert(err);
            });
    }

    function showData(data) {

        //#region Billing Summary

        $("#activeUsersCount").text(sumProperty(data.usages, 'user-license', 'usageQuantity', true));
        $("#prePaidUsersCount").text(sumProperty(data.usages, 'user-license', 'prepayQuantity', true));
        $("#contractEndDate").text(moment(data.contractEndDate).utc().format('LL'));
        $("#contractedAmount").text(sumProperty(data.usages, 'user-license', 'prepayQuantity', false));

        //#endregion

        console.log('Data:', data);

        $("#dateRange").text(`(${moment.utc(data.billingPeriodStartDate).format('L')}-${moment.utc(data.billingPeriodEndDate).format('L')})`);
        let currency = data.currency;

        //#region Users

        let userUsage = data.usages.filter(usage => usage.grouping === 'user-license' && usage.prepayQuantity > 0);
        userUsage.sort(function (a, b) {

            var textA = a.name.toLowerCase();
            var textB = b.name.toLowerCase();

            if (textA < textB)
                return -1;
            if (textA > textB)
                return 1;
            return 0;
        });

        $.each(userUsage, (i, usage) => {

            // Row
            let tr = $("<tr/>", { class: 'usage-item td-padding-top bold-table-data' }).appendTo('#users-tbody');

            // Name
            $("<td/>", {}).text(usage.name).appendTo(tr);

            // Qty
            $("<td/>", {}).text(usage.usageQuantity).appendTo(tr);

            // Unit of measure
            let unitOfMeasureTd = $("<td/>", {}).appendTo(tr);
            $("<span/>", { class: "unit-of-measure" }).text(usage.unitOfMeasureType + 's').appendTo(unitOfMeasureTd);

            // Rate
            $("<td/>", {}).appendTo(tr);

            // Total
            $("<td/>", {}).appendTo(tr);

            //#region Contracted Seats

            let contractedSeatsTitle = '- Contracted Seats';
            let contractedSeatsQuantity = Math.max(0, usage.prepayQuantity);
            let contractedSeatsRate = parseFloat(usage.usageQuantity > 0 ? usage.prepayPrice / usage.usageQuantity : "0").toFixed(2);
            let contractedSeatsTotal = parseFloat(contractedSeatsQuantity * contractedSeatsRate).toFixed(2);

            // Row
            let contractedSeatsTr = $("<tr/>", { class: "roll-up-item" }).appendTo("#users-tbody");

            // Name
            let contractedSeatsTd = $("<td/>").appendTo(contractedSeatsTr);
            $("<span/>").text(contractedSeatsTitle).appendTo(contractedSeatsTd);

            // Quantity
            $("<td/>").text(contractedSeatsQuantity).appendTo(contractedSeatsTr);

            // Unit of measure (none here)
            $("<td/>").appendTo(contractedSeatsTr);

            // Rate
            let contractedSeatsRateTd = $("<td/>").appendTo(contractedSeatsTr);
            let contractedSeatsRateSpan = $("<span/>", { class: "currency-number" }).appendTo(contractedSeatsRateTd);
            $("<span/>", { class: "dollar-sign" }).text(currency).appendTo(contractedSeatsRateSpan);
            $("<span/>", { class: "dollar-amount" }).text(contractedSeatsRate).appendTo(contractedSeatsRateSpan);

            // Total
            let contractedSeatsTotalTd = $("<td/>").appendTo(contractedSeatsTr);
            let contractedSeatsTotalSpan = $("<span/>", { class: "currency-number" }).appendTo(contractedSeatsTotalTd);
            $("<span/>", { class: "dollar-sign" }).text(currency).appendTo(contractedSeatsTotalSpan);
            $("<span/>", { class: "dollar-amount" }).text(contractedSeatsTotal).appendTo(contractedSeatsTotalSpan);

            // Pre-Paid
            $("<td/>", { class: "pre-paid" }).text("Pre-Paid").appendTo(contractedSeatsTr);

            //#endregion

            //#region Overage Seats

            let overageSeatsTitle = '- Overage Seats';
            let overageSeatsQuantity = Math.max(0, usage.usageQuantity - usage.prepayQuantity);
            let overageSeatsRate = parseFloat(usage.overagePrice + usage.prepayPrice).toFixed(2);
            let overageSeatsTotal = parseFloat(overageSeatsQuantity * overageSeatsRate).toFixed(2);

            // Row
            let overageSeatsTr = $("<tr/>", { class: "roll-up-item border-bottom td-padding-bottom" }).appendTo("#users-tbody");

            // Title
            let overageSeatsTd = $("<td/>").appendTo(overageSeatsTr);
            $("<span/>").text(overageSeatsTitle).appendTo(overageSeatsTd);

            // Quantity
            $("<td/>").text(overageSeatsQuantity).appendTo(overageSeatsTr);

            // Unit of measure (none here)
            $("<td/>").appendTo(overageSeatsTr);

            // Rate
            let overageSeatsRateTd = $("<td/>").appendTo(overageSeatsTr);
            let overageSeatsRateSpan = $("<span/>", { class: "currency-number" }).appendTo(overageSeatsRateTd);
            $("<span/>", { class: "dollar-sign" }).text(currency).appendTo(overageSeatsRateSpan);
            $("<span/>", { class: "dollar-amount" }).text(overageSeatsRate).appendTo(overageSeatsRateSpan);

            // Total
            let overageSeatsTotalTd = $("<td/>").appendTo(overageSeatsTr);
            let overageSeatsTotalSpan = $("<span/>", { class: "currency-number" }).appendTo(overageSeatsTotalTd);
            $("<span/>", { class: "dollar-sign" }).text(currency).appendTo(overageSeatsTotalSpan);
            $("<span/>", { class: "dollar-amount" }).text(overageSeatsTotal).appendTo(overageSeatsTotalSpan);

            //#endregion

        });

        //#endregion

        //#region Apps

        let appsUsage = data.usages.filter(usage => usage.grouping === 'billable-app-org-license' && usage.prepayQuantity > 0);
        appsUsage.sort(function (a, b) {

            var textA = a.name.toLowerCase();
            var textB = b.name.toLowerCase();

            if (textA < textB)
                return -1;
            if (textA > textB)
                return 1;
            return 0;
        });

        $.each(appsUsage, (i, usage) => {

            let appName = usage.name;
            let appQuantity = usage.usageQuantity;

            // Row
            let tr = $("<tr/>", { class: 'usage-item td-padding-top bold-table-data' }).appendTo('#apps-tbody');

            // Name
            $("<td/>", {}).text(appName).appendTo(tr);

            // Qty
            $("<td/>", {}).text(appQuantity).appendTo(tr);

            // Unit of measure
            let unitOfMeasureTd = $("<td/>", {}).appendTo(tr);
            $("<span/>", { class: "unit-of-measure" }).text(usage.unitOfMeasureType + 's').appendTo(unitOfMeasureTd);

            // Rate
            $("<td/>", {}).appendTo(tr);

            // Total
            $("<td/>", {}).appendTo(tr);

            //#region Contracted Seats

            let appContractedSeatsTitle = '- Contracted Seats';
            let appContractedSeatsQuantity = Math.max(0, usage.prepayQuantity);
            let appContractedSeatsRate = parseFloat(usage.usageQuantity > 0 ? usage.prepayPrice / usage.usageQuantity : "0").toFixed(2);
            let appContractedSeatsTotal = parseFloat(appContractedSeatsQuantity * appContractedSeatsRate).toFixed(2);

            // Row
            let contractedSeatsTr = $("<tr/>", { class: "roll-up-item" }).appendTo("#apps-tbody");

            // Name
            let contractedSeatsTd = $("<td/>").appendTo(contractedSeatsTr);
            $("<span/>").text(appContractedSeatsTitle).appendTo(contractedSeatsTd);

            // Quantity
            $("<td/>").text(appContractedSeatsQuantity).appendTo(contractedSeatsTr);

            // Unit of measure
            $("<td/>").appendTo(contractedSeatsTr);

            // Rate
            let contractedSeatsRateTd = $("<td/>").appendTo(contractedSeatsTr);
            let contractedSeatsRateSpan = $("<span/>", { class: "currency-number" }).appendTo(contractedSeatsRateTd);
            $("<span/>", { class: "dollar-sign" }).text(currency).appendTo(contractedSeatsRateSpan);
            $("<span/>", { class: "dollar-amount" }).text(appContractedSeatsRate).appendTo(contractedSeatsRateSpan);

            // Total
            let contractedSeatsTotalTd = $("<td/>").appendTo(contractedSeatsTr);
            let contractedSeatsTotalSpan = $("<span/>", { class: "currency-number" }).appendTo(contractedSeatsTotalTd);
            $("<span/>", { class: "dollar-sign" }).text(currency).appendTo(contractedSeatsTotalSpan);
            $("<span/>", { class: "dollar-amount" }).text(appContractedSeatsTotal).appendTo(contractedSeatsTotalSpan);

            // Pre-Paid
            $("<td/>", { class: "pre-paid" }).text("Pre-Paid").appendTo(contractedSeatsTr);

            //#endregion

            //#region Overage Seats

            let appOverageSeatsTitle = '- Overage Seats';
            let appOverageSeatsQuantity = Math.max(0, usage.usageQuantity - usage.prepayQuantity);
            let appOverageSeatsRate = parseFloat(appOverageSeatsQuantity > 0 ? usage.overagePrice / appOverageSeatsQuantity : "0").toFixed(2);
            let appOverageSeatsTotal = parseFloat(appOverageSeatsQuantity * appOverageSeatsRate).toFixed(2);

            // Row
            let overageSeatsTr = $("<tr/>", { class: "roll-up-item border-bottom td-padding-bottom" }).appendTo("#apps-tbody");

            // Name
            let overageSeatsTd = $("<td/>").appendTo(overageSeatsTr);
            $("<span/>").text(appOverageSeatsTitle).appendTo(overageSeatsTd);

            // Quantity
            $("<td/>").text(appOverageSeatsQuantity).appendTo(overageSeatsTr);

            // Unit of measure
            $("<td/>").appendTo(overageSeatsTr);

            // Rate
            let overageSeatsRateTd = $("<td/>").appendTo(overageSeatsTr);
            let overageSeatsRateSpan = $("<span/>", { class: "currency-number" }).appendTo(overageSeatsRateTd);
            $("<span/>", { class: "dollar-sign" }).text(currency).appendTo(overageSeatsRateSpan);
            $("<span/>", { class: "dollar-amount" }).text(appOverageSeatsRate).appendTo(overageSeatsRateSpan);

            // Total
            let overageSeatsTotalTd = $("<td/>").appendTo(overageSeatsTr);
            let overageSeatsTotalSpan = $("<span/>", { class: "currency-number" }).appendTo(overageSeatsTotalTd);
            $("<span/>", { class: "dollar-sign" }).text(currency).appendTo(overageSeatsTotalSpan);
            $("<span/>", { class: "dollar-amount" }).text(appOverageSeatsTotal).appendTo(overageSeatsTotalSpan);

            //#endregion

        });

        //#endregion

        //#region Devices

        let devicesUsage = data.usages.filter(usage => usage.grouping === 'device');
        devicesUsage.sort(function (a, b) {

            var textA = a.name.toLowerCase();
            var textB = b.name.toLowerCase();

            if (textA < textB)
                return -1;
            if (textA > textB)
                return 1;
            return 0;
        });

        $.each(devicesUsage, (i, usage) => {

            let deviceTitle = usage.name;
            let deviceQuantity = usage.usageQuantity;

            // Row
            let tr = $("<tr/>", { class: 'usage-item td-padding-top' }).appendTo('#devices-tbody');

            // Name
            $("<td/>", {}).text(deviceTitle).appendTo(tr);

            // Qty
            $("<td/>", {}).text(deviceQuantity).appendTo(tr);

            // Unit of measure
            let unitOfMeasureTd = $("<td/>", {}).appendTo(tr);
            $("<span/>", { class: "unit-of-measure" }).text(usage.unitOfMeasureType + 's').appendTo(unitOfMeasureTd);

        });

        //#endregion

        //#region Resources

        let resourcesUsage = data.usages.filter(usage => usage.grouping === 'ivr' && usage.usageQuantity > 0);
        resourcesUsage.sort(function (a, b) {
            var textA = a.name.toLowerCase();
            var textB = b.name.toLowerCase();

            if (textA < textB)
                return -1;
            if (textA > textB)
                return 1;
            return 0;
        });

        $.each(resourcesUsage, (i, usage) => {

            let resourceTitle = usage.name;
            let resourceQuantity = usage.usageQuantity;

            // Row
            let tr = $("<tr/>", { class: 'usage-item td-padding-top' }).appendTo('#resources-tbody');

            // Name
            $("<td/>", {}).text(resourceTitle).appendTo(tr);

            // Qty
            $("<td/>", {}).text(resourceQuantity).appendTo(tr);

            // Unit of measure
            let unitOfMeasureTd = $("<td/>", {}).appendTo(tr);
            $("<span/>", { class: "unit-of-measure" }).text(usage.unitOfMeasureType + 's').appendTo(unitOfMeasureTd);
        });

        //#endregion

        //#region Storage

        let storageUsage = data.usages.filter(usage => usage.grouping === 'storage');
        storageUsage.sort(function (a, b) {
            var textA = a.name.toLowerCase();
            var textB = b.name.toLowerCase();

            if (textA < textB)
                return -1;
            if (textA > textB)
                return 1;
            return 0;
        });

        $.each(storageUsage, (i, usage) => {

            let storageTitle = 'Storage';
            let storageTotal = Math.max(usage.prepayPrice, usage.overagePrice).toFixed(2) || 0.00;
            let storageIncluded = usage.prepayQuantity;
            let storageUsed = usage.usageQuantity;

            // Top section
            let storageTbody = $("<tbody/>", { id: "storage-tbody" }).insertAfter("#resources-tbody");
            let storageTr = $("<tr/>", { class: "usage-item border-bottom td-padding-top td-padding-bottom bold-table-data" }).appendTo(storageTbody);
            $("<td/>").text(storageTitle).appendTo(storageTr);

            // Name
            $("<td/>").appendTo(storageTr);

            // Qty
            $("<td/>").appendTo(storageTr);

            // Unit of measure
            $("<td/>").appendTo(storageTr);

            // Storage Total
            let totalTd = $("<td/>", {}).appendTo(storageTr);
            let totalSpan = $("<span/>", { class: "currency-number" }).appendTo(totalTd);
            $("<span/>", { class: "dollar-sign" }).text(currency || "").appendTo(totalSpan);
            $("<span/>", { class: "dollar-amount" }).text(storageTotal).appendTo(totalSpan);

            $("<td/>").appendTo(storageTr);

            //#region Storage Included

            let storageIncludedTr = $("<tr/>", { class: "usage-item td-padding-top" }).appendTo(storageTbody);
            $("<td/>").text("Included").appendTo(storageIncludedTr);

            // Amount
            $("<td/>").text(storageIncluded).appendTo(storageIncludedTr);

            // Unit of measure
            let unitOfMeasureTd = $("<td/>").appendTo(storageIncludedTr);
            $("<span/>", { class: "unit-of-measure" }).text(usage.unitOfMeasureType.toUpperCase()).appendTo(unitOfMeasureTd);

            // Rate
            if (storageUsed > storageIncluded) {
                let rateTd = $("<td/>").appendTo(storageIncludedTr);
                let rateSpan = $("<span/>", { class: "currency-number" }).appendTo(rateTd);
                $("<span/>", { class: "dollar-sign" }).text(currency || "").appendTo(rateSpan);
                $("<span/>", { class: "dollar-amount" }).text(Math.max(usage.prepayPrice, usage.overagePrice).toFixed(2) || 0.00).appendTo(rateSpan);
            } else {
                $("<td/>", { class: "pre-paid" }).text("Included").appendTo(storageIncludedTr);
            }

            //#endregion

            //#region Storage Overage

            let storageOverageTr = $("<tr/>", { class: "usage-item td-padding-top td-padding-bottom" }).appendTo(storageTbody);
            $("<td/>").text("Overage").appendTo(storageOverageTr);

            // Amount
            $("<td/>").text(Math.max(0, usage.usageQuantity - usage.prepayQuantity)).appendTo(storageOverageTr);

            // Unit of measure
            let unitOfMeasureTd2 = $("<td/>").appendTo(storageOverageTr);
            $("<span/>", { class: "unit-of-measure" }).text(usage.unitOfMeasureType.toUpperCase()).appendTo(unitOfMeasureTd2);

            //#endregion

            //#region Storage Usage

            let storageCategories = data.usages.filter(usage => usage.grouping === 'storage-category' && usage.usageQuantity > 0);
            storageCategories.sort(function (a, b) {
                var textA = a.name.toLowerCase();
                var textB = b.name.toLowerCase();

                if (textA < textB)
                    return -1;
                if (textA > textB)
                    return 1;
                return 0;
            });

            // Top section
            let storageDetailsTr = $("<tr/>", { class: "usage-item td-padding-top" }).appendTo(storageTbody);
            $("<td/>").text("Storage Usage").appendTo(storageDetailsTr);

            // Each item
            let totalCategories = 0.0;
            $.each(storageCategories, (i, usage) => {
                let storageItem;
                if (i === storageCategories.length - 1) {
                    storageItem = $("<tr/>", { class: "roll-up-item border-bottom td-padding-bottom" }).appendTo(storageTbody);
                } else {
                    storageItem = $("<tr/>", { class: "roll-up-item" }).appendTo(storageTbody);
                }
                $("<td/>").text('- ' + usage.name).appendTo(storageItem);
                $("<td/>").text(parseFloat(usage.usageQuantity).toFixed(2)).appendTo(storageItem);
                $("<td/>").appendTo(storageItem);
                $("<td/>").appendTo(storageItem);
                $("<td/>").appendTo(storageItem);
                $("<td/>").appendTo(storageItem);
                totalCategories += parseFloat(usage.usageQuantity);
            });

            //Total
            $("<td/>").text(parseFloat(totalCategories).toFixed(0)).appendTo(storageDetailsTr);
            let categoriesUnitOfMeasureTd = $("<td/>").appendTo(storageDetailsTr);
            $("<span/>", { class: "unit-of-measure" }).text(usage.unitOfMeasureType.toUpperCase()).appendTo(categoriesUnitOfMeasureTd);

            //#endregion
        });

        //#endregion

    }

    function sumProperty(data, grouping, property, ignoreZeroUsageQuantity) {
        let items = data.filter(item => ignoreZeroUsageQuantity ? item.grouping === grouping : item.group === grouping && item.usageQuantity > 0);
        return items.reduce(function (a, b) {
            return a + (b[property] ? parseInt(b[property]) : 0);
        }, 0);
    }

    $("#selectPeriod").on('change', () => {
        $("#users-tbody").empty();
        $("#apps-tbody").empty();
        $("#devices-tbody").empty();
        $("#resources-tbody").empty();
        $("#storage-tbody").empty();

        start();
    });
</script>

</html>